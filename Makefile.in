##### CPU variants #####
GCCARCH = $(shell uname -m)

ifeq ($(GCCARCH),x86_64)
  GCCARCH = core2
endif

ifeq ($(findstring arm,$(GCCARCH)),arm)
  GCCARCH = armv6k
endif

objects = codec_alaw.o codec_ulaw.o format_slinear.o format_wav.o format_ogg.o calltable.o rtp.o voipmonitor.o sniff.o jitterbuffer/astmm.o jitterbuffer/utils.o jitterbuffer/fixedjitterbuf.o jitterbuffer/jitterbuf.o jitterbuffer/abstract_jb.o jitterbuffer/frame.o gzstream/gzstream.o gzstream/libgzstream.a manager.o tools.o filter_mysql.o hash.o mos_g729.o odbc.o rtcp.o sql_db.o
#args = -g3 -Wall  -march=$(GCCARCH)
#args = -O2 -Wall -march=$(GCCARCH)
#CFLAGS+=-I /usr/local/include/mysql++/ -I /usr/include/mysql++/ -I /usr/include/mysql/ -g3 -Wall -I jitterbuffer/  -L/usr/local/lib/ -Lgzstream/ -Lliblfds.6/bin/ -fPIC

#LDFLAGS := $(LDFLAGS) -static -static-libgcc

shared: LIBS=-lpthread -lpcap -lgzstream -lz -lvorbis -lvorbisenc -logg -lodbc -llfds -lmysqlclient #-lnids
shared: CFLAGS+= -DQUEUE_NONBLOCK -I /usr/local/include/mysql++/ -I /usr/include/mysql++/ -I /usr/include/mysql/ -g3 -Wall -I jitterbuffer/  -L/usr/local/lib/ -Lgzstream/ -Lliblfds.6/bin/ -fPIC
shared: args = -g3 -Wall  -march=$(GCCARCH)

static: LIBS=-static -L/usr/lib/mysql -lodbc -lltdl -ldl -lrt -lz -lcrypt -lm -lssl -static-libstdc++ -static-libgcc -lpcap -L/usr/lib/mysql -lmysqlclient -lpthread -lgzstream -lz -lc -lvorbis -lvorbisenc -logg -llfds
static: CFLAGS+= -I /usr/local/include/mysql++/ -I /usr/include/mysql++/ -I /usr/include/mysql/ -g3 -Wall -I jitterbuffer/  -L/usr/local/lib/ -Lgzstream/ -Lliblfds.6/bin/ -fPIC
static: args = -g3 -Wall  -march=$(GCCARCH)

armv5shared: LIBS=-lpthread -lpcap -lgzstream -lz -lvorbis -lvorbisenc -logg -lodbc 
armv5shared: CFLAGS+=-I /usr/local/include/mysql++/ -I /usr/include/mysql++/ -I /usr/include/mysql/ -g3 -Wall -I jitterbuffer/  -L/usr/local/lib/ -Lgzstream/ -fPIC
armv5shared: args = -g3 -Wall  -march=armv5

armv5static: LIBS=-static -L/usr/lib/mysql -lodbc -lltdl -ldl -lrt -lz -lcrypt -lm -lssl -static-libstdc++ -static-libgcc -lpcap -L/usr/lib/mysql -lmysqlclient -lpthread -lgzstream -lz -lc -lvorbis -lvorbisenc -logg 
armv5static: CFLAGS+=-I /usr/local/include/mysql++/ -I /usr/include/mysql++/ -I /usr/include/mysql/ -g3 -Wall -I jitterbuffer/  -L/usr/local/lib/ -Lgzstream/ -fPIC
armv5static: args = -g3 -Wall  -march=armv5

shared: cleantest $(objects) 
	make -C liblfds.6
	g++ $(objects) ${CFLAGS} -o voipmonitor ${LIBS}

static: cleantest $(objects)
	make -C liblfds.6
	g++ $(objects) ${CFLAGS} -o voipmonitor ${LIBS}

armv5shared: cleantest $(objects)
	g++ $(objects) ${CFLAGS} -o voipmonitor ${LIBS}

armv5static: cleantest $(objects)
	g++ $(objects) ${CFLAGS} -o voipmonitor ${LIBS}

cleantest:
	@cmp -s .cleancount .lastclean || $(MAKE) clean

gzstream/gzstream.o : gzstream/gzstream.C gzstream/gzstream.h
	g++ -I. -Igzstream/ -c -o gzstream/gzstream.o gzstream/gzstream.C

gzstream/libgzstream.a : gzstream/gzstream.o
	ar cr gzstream/libgzstream.a gzstream/gzstream.o

codec_alaw.o : codec_alaw.cpp codec_alaw.h
	g++ -c codec_alaw.cpp $(args) ${CFLAGS}

codec_ulaw.o : codec_ulaw.cpp codec_ulaw.h
	g++ -c codec_ulaw.cpp $(args) ${CFLAGS}

format_slinear.o : format_slinear.cpp format_slinear.h
	g++ -c format_slinear.cpp $(args) ${CFLAGS}

format_wav.o : format_wav.cpp format_wav.h
	g++ -c format_wav.cpp $(args) ${CFLAGS}

format_ogg.o : format_ogg.cpp format_ogg.h
	g++ -c format_ogg.cpp $(args) ${CFLAGS}

calltable.o : calltable.cpp calltable.h
	g++ -c calltable.cpp $(args) ${CFLAGS}

rtp.o : rtp.cpp rtp.h
	g++ -c rtp.cpp $(args) ${CFLAGS}

rtcp.o : rtcp.cpp rtcp.h
	g++ -c rtcp.cpp $(args) ${CFLAGS}

voipmonitor.o : voipmonitor.cpp voipmonitor.h
	g++ -c voipmonitor.cpp $(args) ${CFLAGS}

sniff.o : sniff.cpp sniff.h
	g++ -c sniff.cpp $(args) ${CFLAGS}

manager.o : manager.cpp manager.h
	g++ -c manager.cpp $(args) ${CFLAGS}

tools.o : tools.cpp tools.h
	g++ -c tools.cpp $(args) ${CFLAGS}

filter_mysql.o : filter_mysql.cpp filter_mysql.h
	g++ -c filter_mysql.cpp $(args) ${CFLAGS}

hash.o : hash.cpp hash.h
	g++ -c hash.cpp $(args) ${CFLAGS}

mos_g729.o : mos_g729.cpp mos_g729.h
	g++ -c mos_g729.cpp $(args) ${CFLAGS}

odbc.o : odbc.cpp odbc.h
	g++ -c odbc.cpp $(args) ${CFLAGS}
	
sql_db.o : sql_db.cpp sql_db.h
	g++ -c sql_db.cpp $(args) ${CFLAGS}

clean :
	make -C liblfds.6 clean
	rm -f $(objects) voipmonitor gzstream/*.o libgzstream.a
	cp -f .cleancount .lastclean

targz64: static
	rm -rf /tmp/voipmonitor-amd64-4.2-static*
	mkdir -p /tmp/voipmonitor-amd64-4.2-static/usr/local/sbin
	cp cdrtable.sql /tmp/voipmonitor-amd64-4.2-static/
	strip voipmonitor
	cp voipmonitor /tmp/voipmonitor-amd64-4.2-static/usr/local/sbin/
	mkdir -p /tmp/voipmonitor-amd64-4.2-static/etc/init.d
	cp config/voipmonitor.conf /tmp/voipmonitor-amd64-4.2-static/etc/
	cp config/init.d/voipmonitor /tmp/voipmonitor-amd64-4.2-static/etc/init.d/
	cp scripts/install-script.sh /tmp/voipmonitor-amd64-4.2-static/
	tar czf /tmp/voipmonitor-amd64-4.2-static.tar.gz /tmp/voipmonitor-amd64-4.2-static
	
install: 
	install voipmonitor /usr/local/sbin/

